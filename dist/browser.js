(function(v,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(v=typeof globalThis<"u"?globalThis:v||self,E(v.ArkeUploadClient={}))})(this,function(v){"use strict";var St=Object.defineProperty;var Ct=(v,E,$)=>E in v?St(v,E,{enumerable:!0,configurable:!0,writable:!0,value:$}):v[E]=$;var h=(v,E,$)=>Ct(v,typeof E!="symbol"?E+"":E,$);var me;class E extends Error{constructor(e,t,n){super(e),this.statusCode=t,this.details=n,this.name="WorkerAPIError",Error.captureStackTrace(this,this.constructor)}}class $ extends Error{constructor(e,t,n){super(e),this.fileName=t,this.cause=n,this.name="UploadError",Error.captureStackTrace(this,this.constructor)}}class C extends Error{constructor(e,t){super(e),this.field=t,this.name="ValidationError",Error.captureStackTrace(this,this.constructor)}}class _ extends Error{constructor(e,t){super(e),this.cause=t,this.name="NetworkError",Error.captureStackTrace(this,this.constructor)}}class D extends Error{constructor(e,t){super(e),this.path=t,this.name="ScanError",Error.captureStackTrace(this,this.constructor)}}function ye(r){return r instanceof _?!0:r instanceof E?r.statusCode?r.statusCode>=500:!1:r.code==="ECONNRESET"||r.code==="ETIMEDOUT"||r.code==="ENOTFOUND"||r.code==="ECONNREFUSED"}const be={maxRetries:3,initialDelay:1e3,maxDelay:3e4,shouldRetry:ye};async function N(r,e={}){const t={...be,...e};let n;for(let o=0;o<=t.maxRetries;o++)try{return await r()}catch(i){if(n=i,o>=t.maxRetries||t.shouldRetry&&!t.shouldRetry(i))throw i;const a=Math.min(t.initialDelay*Math.pow(2,o),t.maxDelay);await xe(a)}throw n}function xe(r){return new Promise(e=>setTimeout(e,r))}class ve{constructor(e){h(this,"baseUrl");h(this,"timeout");h(this,"maxRetries");h(this,"debug");this.baseUrl=e.baseUrl,this.timeout=e.timeout??3e4,this.maxRetries=e.maxRetries??3,this.debug=e.debug??!1}async request(e,t,n){const o=`${this.baseUrl}${t}`;this.debug&&console.log(`HTTP Request: ${e} ${o}`,n);try{const i=new AbortController,a=setTimeout(()=>i.abort(),this.timeout),s=await fetch(o,{method:e,headers:{"Content-Type":"application/json"},body:n?JSON.stringify(n):void 0,signal:i.signal});clearTimeout(a);const l=await s.json();if(this.debug&&console.log(`HTTP Response: ${s.status}`,l),!s.ok){const u=l;throw new E(u.error||"Request failed",s.status,u.details)}return l}catch(i){throw i instanceof E?i:i.name==="AbortError"?new _(`Request timeout after ${this.timeout}ms`):new _(`Network request failed: ${i.message}`)}}async initBatch(e){return N(()=>this.request("POST","/api/batches/init",e),{maxRetries:this.maxRetries})}async startFileUpload(e,t){return N(()=>this.request("POST",`/api/batches/${e}/files/start`,t),{maxRetries:this.maxRetries})}async completeFileUpload(e,t){return N(()=>this.request("POST",`/api/batches/${e}/files/complete`,t),{maxRetries:this.maxRetries})}async finalizeBatch(e){return N(()=>this.request("POST",`/api/batches/${e}/finalize`,{}),{maxRetries:this.maxRetries})}}function Ee(){return typeof process<"u"&&process.versions!=null&&process.versions.node!=null?"node":typeof window<"u"&&typeof document<"u"?"browser":"unknown"}function Z(r){return r.replace(/\\/g,"/")}function Se(r){const e=r.lastIndexOf(".");return e===-1?"":r.slice(e+1).toLowerCase()}function Y(r){const e=Se(r);return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp",svg:"image/svg+xml",pdf:"application/pdf",txt:"text/plain",json:"application/json",xml:"application/xml",html:"text/html",htm:"text/html",css:"text/css",js:"application/javascript",zip:"application/zip",tar:"application/x-tar",gz:"application/gzip",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime"}[e]||"application/octet-stream"}async function Ce(r,e,t,n=3){await N(async()=>{try{const o=await fetch(e,{method:"PUT",body:r,headers:{...t?{"Content-Type":t}:{}}});if(!o.ok)throw new $(`Upload failed with status ${o.status}: ${o.statusText}`)}catch(o){throw o instanceof $?o:new $(`Upload failed: ${o.message}`)}},{maxRetries:n})}async function $e(r,e,t=3){const n=r.byteLength,o=Math.ceil(n/e.length),i=[],a=[];for(let s=0;s<e.length;s++){const l=s+1,u=s*o,c=Math.min(u+o,n),f=r.slice(u,c),m=e[s];a.push(async()=>{const T=await Te(f,m,l);i.push({part_number:l,etag:T})})}return await Pe(a,t),i.sort((s,l)=>s.part_number-l.part_number),i}async function Te(r,e,t,n=3){return N(async()=>{try{const o=await fetch(e,{method:"PUT",body:r});if(!o.ok)throw new $(`Part ${t} upload failed with status ${o.status}: ${o.statusText}`);const i=o.headers.get("etag");if(!i)throw new $(`Part ${t} upload succeeded but no ETag returned`);return i.replace(/"/g,"")}catch(o){throw o instanceof $?o:new $(`Part ${t} upload failed: ${o.message}`)}},{maxRetries:n})}async function Pe(r,e){const t=[...r],n=[],o=async()=>{for(;t.length>0;)await t.shift()()};for(let i=0;i<Math.min(e,r.length);i++)n.push(o());await Promise.all(n)}const ee=5*1024*1024*1024,te=100*1024*1024*1024,Ue=/[<>:"|?*\x00-\x1f]/,ze=["image/jpeg","image/png","image/webp"];function re(r){if(r<=0)throw new C("File size must be greater than 0");if(r>ee)throw new C(`File size (${L(r)}) exceeds maximum allowed size (${L(ee)})`)}function Ae(r){if(r>te)throw new C(`Total batch size (${L(r)}) exceeds maximum allowed size (${L(te)})`)}function M(r){if(!r.startsWith("/"))throw new C("Logical path must start with /","path");if(Ue.test(r))throw new C("Logical path contains invalid characters","path");const e=r.split("/").filter(t=>t.length>0);if(e.length===0&&r!=="/")throw new C("Logical path cannot be empty","path");for(const t of e)if(t==="."||t==="..")throw new C("Logical path cannot contain . or .. segments","path")}function ke(r,e,t){let n;try{n=JSON.parse(r)}catch(o){throw new C(`Invalid JSON in ${e}: ${o.message}`,"ref")}if(typeof n!="object"||Array.isArray(n)||n===null)throw new C(`${e} must contain a JSON object`,"ref");if(!n.url||typeof n.url!="string")throw new C(`${e} must contain a 'url' field with a string value`,"ref");try{const o=new URL(n.url);if(o.protocol!=="http:"&&o.protocol!=="https:")throw new Error("URL must use HTTP or HTTPS protocol")}catch(o){throw new C(`Invalid URL in ${e}: ${o.message}`,"ref")}if(n.type||t&&t.warn(`${e}: Missing 'type' field (optional but recommended)`),n.type&&ze.includes(n.type)){const i={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"}[n.type];i&&!e.includes(`${i}.ref.json`)&&t&&t.warn(`${e}: Type is '${n.type}' but filename doesn't include '${i}.ref.json' pattern. This file may not be processed by OCR. Consider renaming to include the extension (e.g., 'photo${i}.ref.json').`)}}function L(r){if(r===0)return"0 B";const e=1024,t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(r)/Math.log(e));return`${(r/Math.pow(e,n)).toFixed(2)} ${t[n]}`}class De{constructor(e){h(this,"config");h(this,"workerClient");h(this,"scanner",null);h(this,"platform");this.config={rootPath:"/",parallelUploads:5,parallelParts:3,...e},this.workerClient=new ve({baseUrl:e.workerUrl,debug:!1}),this.platform=Ee()}async getScanner(){if(this.scanner)return this.scanner;if(this.platform==="node"){const{NodeScanner:e}=await Promise.resolve().then(()=>xt);this.scanner=new e}else if(this.platform==="browser"){const{BrowserScanner:e}=await Promise.resolve().then(()=>Et);this.scanner=new e}else throw new C("Unsupported platform");return this.scanner}async uploadBatch(e,t={}){const n=Date.now(),{onProgress:o,dryRun:i=!1}=t;this.reportProgress(o,{phase:"scanning",filesTotal:0,filesUploaded:0,bytesTotal:0,bytesUploaded:0,percentComplete:0});const s=await(await this.getScanner()).scanFiles(e,{rootPath:this.config.rootPath||"/",followSymlinks:!0,defaultProcessingConfig:this.config.processing});if(s.length===0)throw new C("No files found to upload");const l=s.reduce((m,T)=>m+T.size,0);if(Ae(l),i)return{batchId:"dry-run",filesUploaded:s.length,bytesUploaded:l,durationMs:Date.now()-n};const{batch_id:u}=await this.workerClient.initBatch({uploader:this.config.uploader,root_path:this.config.rootPath||"/",parent_pi:this.config.parentPi||"",metadata:this.config.metadata,file_count:s.length,total_size:l});this.reportProgress(o,{phase:"uploading",filesTotal:s.length,filesUploaded:0,bytesTotal:l,bytesUploaded:0,percentComplete:0});let c=0,f=0;return await this.uploadFilesWithConcurrency(u,s,e,this.config.parallelUploads||5,(m,T)=>{c++,f+=T,this.reportProgress(o,{phase:"uploading",filesTotal:s.length,filesUploaded:c,bytesTotal:l,bytesUploaded:f,currentFile:m.fileName,percentComplete:Math.round(f/l*100)})}),this.reportProgress(o,{phase:"finalizing",filesTotal:s.length,filesUploaded:c,bytesTotal:l,bytesUploaded:f,percentComplete:99}),await this.workerClient.finalizeBatch(u),this.reportProgress(o,{phase:"complete",filesTotal:s.length,filesUploaded:c,bytesTotal:l,bytesUploaded:f,percentComplete:100}),{batchId:u,filesUploaded:c,bytesUploaded:f,durationMs:Date.now()-n}}async uploadFilesWithConcurrency(e,t,n,o,i){const a=[...t],s=[],l=async()=>{for(;a.length>0;){const u=a.shift();await this.uploadSingleFile(e,u,n),i(u,u.size)}};for(let u=0;u<Math.min(o,t.length);u++)s.push(l());await Promise.all(s)}async uploadSingleFile(e,t,n){const o=await this.workerClient.startFileUpload(e,{file_name:t.fileName,file_size:t.size,logical_path:t.logicalPath,content_type:t.contentType,cid:t.cid,processing_config:t.processingConfig}),i=await this.getFileData(t,n);if(o.upload_type==="simple")await Ce(i,o.presigned_url);else{const a=o.presigned_urls.map(l=>l.url),s=await $e(i,a,this.config.parallelParts||3);await this.workerClient.completeFileUpload(e,{r2_key:o.r2_key,upload_id:o.upload_id,parts:s});return}await this.workerClient.completeFileUpload(e,{r2_key:o.r2_key})}async getFileData(e,t){if(this.platform==="node"){const o=await(await Promise.resolve().then(()=>ne)).readFile(e.localPath);return o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength)}else if(this.platform==="browser"){const o=(Array.isArray(t)?t:[t]).find(i=>i instanceof File&&i.name===e.fileName);if(!o)throw new Error(`Could not find browser File object for ${e.fileName}`);return o.arrayBuffer()}throw new Error("Unsupported platform for file reading")}reportProgress(e,t){e&&e(t)}}const S={},ne=Object.freeze(Object.defineProperty({__proto__:null,default:S},Symbol.toStringTag,{value:"Module"}));function Fe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function J(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Oe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var i=r.charAt(o),a=i.charCodeAt(0);if(t[a]!==255)throw new TypeError(i+" is ambiguous");t[a]=o}var s=r.length,l=r.charAt(0),u=Math.log(s)/Math.log(256),c=Math.log(256)/Math.log(s);function f(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var w=0,y=0,x=0,p=d.length;x!==p&&d[x]===0;)x++,w++;for(var g=(p-x)*c+1>>>0,P=new Uint8Array(g);x!==p;){for(var z=d[x],O=0,U=g-1;(z!==0||O<y)&&U!==-1;U--,O++)z+=256*P[U]>>>0,P[U]=z%s>>>0,z=z/s>>>0;if(z!==0)throw new Error("Non-zero carry");y=O,x++}for(var k=g-y;k!==g&&P[k]===0;)k++;for(var W=l.repeat(w);k<g;++k)W+=r.charAt(P[k]);return W}function m(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var w=0;if(d[w]!==" "){for(var y=0,x=0;d[w]===l;)y++,w++;for(var p=(d.length-w)*u+1>>>0,g=new Uint8Array(p);d[w];){var P=t[d.charCodeAt(w)];if(P===255)return;for(var z=0,O=p-1;(P!==0||z<x)&&O!==-1;O--,z++)P+=s*g[O]>>>0,g[O]=P%256>>>0,P=P/256>>>0;if(P!==0)throw new Error("Non-zero carry");x=z,w++}if(d[w]!==" "){for(var U=p-x;U!==p&&g[U]===0;)U++;for(var k=new Uint8Array(y+(p-U)),W=y;U!==p;)k[W++]=g[U++];return k}}}function T(d){var w=m(d);if(w)return w;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:m,decode:T}}var Ne=Oe,Re=Ne;class _e{constructor(e,t,n){h(this,"name");h(this,"prefix");h(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Me{constructor(e,t,n){h(this,"name");h(this,"prefix");h(this,"baseDecode");h(this,"prefixCodePoint");this.name=e,this.prefix=t;const o=t.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return oe(this,e)}}class Le{constructor(e){h(this,"decoders");this.decoders=e}or(e){return oe(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function oe(r,e){return new Le({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class Ie{constructor(e,t,n,o){h(this,"name");h(this,"prefix");h(this,"baseEncode");h(this,"baseDecode");h(this,"encoder");h(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new _e(e,t,n),this.decoder=new Me(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function ie({name:r,prefix:e,encode:t,decode:n}){return new Ie(r,e,t,n)}function I({name:r,prefix:e,alphabet:t}){const{encode:n,decode:o}=Re(t,r);return ie({prefix:e,name:r,encode:n,decode:i=>J(o(i))})}function je(r,e,t,n){let o=r.length;for(;r[o-1]==="=";)--o;const i=new Uint8Array(o*t/8|0);let a=0,s=0,l=0;for(let u=0;u<o;++u){const c=e[r[u]];if(c===void 0)throw new SyntaxError(`Non-${n} character`);s=s<<t|c,a+=t,a>=8&&(a-=8,i[l++]=255&s>>a)}if(a>=t||255&s<<8-a)throw new SyntaxError("Unexpected end of data");return i}function Be(r,e,t){const n=e[e.length-1]==="=",o=(1<<t)-1;let i="",a=0,s=0;for(let l=0;l<r.length;++l)for(s=s<<8|r[l],a+=8;a>t;)a-=t,i+=e[o&s>>a];if(a!==0&&(i+=e[o&s<<t-a]),n)for(;i.length*t&7;)i+="=";return i}function qe(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function A({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const o=qe(n);return ie({prefix:e,name:r,encode(i){return Be(i,n,t)},decode(i){return je(i,o,t,r)}})}const j=A({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});A({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),A({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),A({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),A({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),A({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),A({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),A({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),A({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const G=I({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});I({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const F=I({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});I({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ve=ae,se=128,We=-128,Je=Math.pow(2,31);function ae(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Je;)e[t++]=r&255|se,r/=128;for(;r&We;)e[t++]=r&255|se,r>>>=7;return e[t]=r|0,ae.bytes=t-n+1,e}var Ge=H,He=128,ce=127;function H(r,n){var t=0,n=n||0,o=0,i=n,a,s=r.length;do{if(i>=s)throw H.bytes=0,new RangeError("Could not decode varint");a=r[i++],t+=o<28?(a&ce)<<o:(a&ce)*Math.pow(2,o),o+=7}while(a>=He);return H.bytes=i-n,t}var Ke=Math.pow(2,7),Qe=Math.pow(2,14),Xe=Math.pow(2,21),Ze=Math.pow(2,28),Ye=Math.pow(2,35),et=Math.pow(2,42),tt=Math.pow(2,49),rt=Math.pow(2,56),nt=Math.pow(2,63),ot=function(r){return r<Ke?1:r<Qe?2:r<Xe?3:r<Ze?4:r<Ye?5:r<et?6:r<tt?7:r<rt?8:r<nt?9:10},it={encode:Ve,decode:Ge,encodingLength:ot},B=it;function K(r,e=0){return[B.decode(r,e),B.decode.bytes]}function q(r,e,t=0){return B.encode(r,e,t),e}function V(r){return B.encodingLength(r)}function le(r,e){const t=e.byteLength,n=V(r),o=n+V(t),i=new Uint8Array(o+t);return q(r,i,0),q(t,i,n),i.set(e,o),new Q(r,t,e,i)}function st(r){const e=J(r),[t,n]=K(e),[o,i]=K(e.subarray(n)),a=e.subarray(n+i);if(a.byteLength!==o)throw new Error("Incorrect length");return new Q(t,o,a,e)}function at(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Fe(r.bytes,t.bytes)}}class Q{constructor(e,t,n,o){h(this,"code");h(this,"size");h(this,"digest");h(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=o}}function he(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return lt(t,X(r),e??F.encoder);default:return ht(t,X(r),e??j.encoder)}}const fe=new WeakMap;function X(r){const e=fe.get(r);if(e==null){const t=new Map;return fe.set(r,t),t}return e}class b{constructor(e,t,n,o){h(this,"code");h(this,"version");h(this,"multihash");h(this,"bytes");h(this,"/");h(this,me,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==R)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ft)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return b.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=le(e,t);return b.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return b.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&at(e.multihash,n.multihash)}toString(e){return he(this,e)}toJSON(){return{"/":he(this)}}link(){return this}[(me=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof b)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:o,multihash:i,bytes:a}=t;return new b(n,o,i,a??de(n,o,i.bytes))}else if(t[dt]===!0){const{version:n,multihash:o,code:i}=t,a=st(o);return b.create(n,i,a)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==R)throw new Error(`Version 0 CID must use dag-pb (code: ${R}) block encoding`);return new b(e,t,n,n.bytes)}case 1:{const o=de(e,t,n.bytes);return new b(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return b.create(0,R,e)}static createV1(e,t){return b.create(1,e,t)}static decode(e){const[t,n]=b.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=b.inspectBytes(e),n=t.size-t.multihashSize,o=J(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=o.subarray(t.multihashSize-t.digestSize),a=new Q(t.multihashCode,t.digestSize,i,o);return[t.version===0?b.createV0(a):b.createV1(t.codec,a),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[f,m]=K(e.subarray(t));return t+=m,f};let o=n(),i=R;if(o===18?(o=0,t=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);const a=t,s=n(),l=n(),u=t+l,c=u-a;return{version:o,codec:i,multihashCode:s,digestSize:l,multihashSize:c,size:u}}static parse(e,t){const[n,o]=ct(e,t),i=b.decode(o);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return X(i).set(n,e),i}}function ct(r,e){switch(r[0]){case"Q":{const t=e??F;return[F.prefix,t.decode(`${F.prefix}${r}`)]}case F.prefix:{const t=e??F;return[F.prefix,t.decode(r)]}case j.prefix:{const t=e??j;return[j.prefix,t.decode(r)]}case G.prefix:{const t=e??G;return[G.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function lt(r,e,t){const{prefix:n}=t;if(n!==F.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const o=e.get(n);if(o==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return o}function ht(r,e,t){const{prefix:n}=t,o=e.get(n);if(o==null){const i=t.encode(r);return e.set(n,i),i}else return o}const R=112,ft=18;function de(r,e,t){const n=V(r),o=n+V(e),i=new Uint8Array(o+t.byteLength);return q(r,i,0),q(e,i,n),i.set(t,o),i}const dt=Symbol.for("@ipld/js-cid/CID"),ue=85,ut=20;function pt({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:o}){return new wt(r,e,t,n,o)}class wt{constructor(e,t,n,o,i){h(this,"name");h(this,"code");h(this,"encode");h(this,"minDigestLength");h(this,"maxDigestLength");this.name=e,this.code=t,this.encode=n,this.minDigestLength=o??ut,this.maxDigestLength=i}digest(e,t){if((t==null?void 0:t.truncate)!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?pe(n,this.code,t==null?void 0:t.truncate):n.then(o=>pe(o,this.code,t==null?void 0:t.truncate))}else throw Error("Unknown type, must be binary type")}}function pe(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return le(e,r)}function gt(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const we=pt({name:"sha2-256",code:18,encode:gt("SHA-256")});async function mt(r){const e=await Promise.resolve().then(()=>ne);try{const t=await e.readFile(r),n=await we.digest(t);return b.create(1,ue,n).toString()}catch(t){throw new Error(`CID computation failed: ${t.message}`)}}async function yt(r){const e=await we.digest(r);return b.create(1,ue,e).toString()}const ge={ocr:!0,describe:!0,pinax:!0};class bt{async scanFiles(e,t){const n=Array.isArray(e)?e[0]:e;if(!n||typeof n!="string")throw new D("Node.js scanner requires a directory path","");const o=[];try{if(!(await S.stat(n)).isDirectory())throw new D(`Path is not a directory: ${n}`,n)}catch(c){throw c.code==="ENOENT"?new D(`Directory not found: ${n}`,n):new D(`Cannot access directory: ${c.message}`,n)}M(t.rootPath);const i=t.defaultProcessingConfig||ge;async function a(c){const f=S.join(c,".arke-process.json");try{const m=await S.readFile(f,"utf-8");return JSON.parse(m)}catch(m){return m.code!=="ENOENT"&&console.warn(`Error reading processing config ${f}: ${m.message}`),null}}function s(c,f){return f?{ocr:f.ocr??c.ocr,describe:f.describe??c.describe,pinax:f.pinax??c.pinax}:c}async function l(c,f=""){const m=await a(c),T=s(i,m);let d;try{d=await S.readdir(c,{withFileTypes:!0})}catch(w){console.warn(`Cannot read directory: ${c}`,w.message);return}for(const w of d){const y=S.join(c,w.name),x=S.join(f,w.name);try{if(w.isSymbolicLink()){if(!t.followSymlinks)continue;const p=await S.stat(y);p.isDirectory()?await l(y,x):p.isFile()&&await u(y,x,p.size,T);continue}if(w.isDirectory()){await l(y,x);continue}if(w.isFile()){const p=await S.stat(y);await u(y,x,p.size,T)}}catch(p){if(p instanceof D&&p.message.includes(".ref.json"))throw p;console.warn(`Error processing ${y}: ${p.message}`);continue}}}async function u(c,f,m,T){const d=S.basename(c);if(d===".arke-process.json")return;if(d.endsWith(".ref.json"))try{const g=await S.readFile(c,"utf-8");ke(g,d,console)}catch(g){throw new D(`Invalid .ref.json file: ${d} - ${g.message}`,c)}try{re(m)}catch(g){console.warn(`Skipping file that exceeds size limit: ${d}`,g.message);return}const w=Z(f),y=S.posix.join(t.rootPath,w);try{M(y)}catch(g){console.warn(`Skipping file with invalid logical path: ${y}`,g.message);return}const x=Y(d);try{await S.access(c,S.constants.R_OK)}catch{console.warn(`Skipping unreadable file: ${c}`);return}let p;try{p=await mt(c)}catch(g){console.warn(`Warning: CID computation failed for ${c}, continuing without CID:`,g.message),p=void 0}o.push({localPath:c,logicalPath:y,fileName:d,size:m,contentType:x,cid:p,processingConfig:T})}return await l(n),o.sort((c,f)=>c.size-f.size),o}async readFile(e){const t=await S.readFile(e.localPath);return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}const xt=Object.freeze(Object.defineProperty({__proto__:null,NodeScanner:bt},Symbol.toStringTag,{value:"Module"}));class vt{async scanFiles(e,t){const n=Array.isArray(e)?e:[e];if(n.length===0)throw new D("No files provided","");M(t.rootPath);const o=t.defaultProcessingConfig||ge,i=[];for(const a of n)try{const s=await this.processFile(a,t.rootPath,o);s&&i.push(s)}catch(s){console.warn(`Error processing ${a.name}: ${s.message}`);continue}return i.sort((a,s)=>a.size-s.size),i}async processFile(e,t,n){const o=e.name,i=e.size;if(o===".arke-process.json")return null;try{re(i)}catch(f){return console.warn(`Skipping file that exceeds size limit: ${o}`,f.message),null}let a="";if("webkitRelativePath"in e&&e.webkitRelativePath){const f=e.webkitRelativePath.split("/");f.length>1?a=f.slice(1).join("/"):a=o}else a=o;const s=Z(a),l=`${t}/${s}`.replace(/\/+/g,"/");try{M(l)}catch(f){return console.warn(`Skipping file with invalid logical path: ${l}`,f.message),null}const u=e.type||Y(o);let c;try{const f=await e.arrayBuffer();c=await yt(new Uint8Array(f))}catch(f){console.warn(`Warning: CID computation failed for ${o}, continuing without CID:`,f.message),c=void 0}return{localPath:`__browser_file__${o}`,logicalPath:l,fileName:o,size:i,contentType:u,cid:c,processingConfig:n}}async readFile(e){throw new Error("Browser scanner requires File objects to be provided directly during upload")}}const Et=Object.freeze(Object.defineProperty({__proto__:null,BrowserScanner:vt},Symbol.toStringTag,{value:"Module"}));v.ArkeUploader=De,v.NetworkError=_,v.ScanError=D,v.UploadError=$,v.ValidationError=C,v.WorkerAPIError=E,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
